<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <!-- Include Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        .user-cursor {
            position: absolute;
            background-color: red;
            width: 2px;
            height: 20px;
            z-index: 10;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h1>{{ title }}</h1>
    <button onclick="saveDocument()">Save</button>
    <button onclick="downloadDocument()">Download</button>
    <button onclick="createNewDocument()">New Document</button>
    <!-- Quill Editor Placeholder -->
    <div id="editor-container">
        <div id="editor"></div>
    </div>

    <!-- Include Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        const docId = "{{ doc_id }}";
        const csrfToken = "{{ csrf_token }}";
        const autosaveInterval = 5000; // Autosave every 5 seconds

        // Initialize Quill editor
        const quill = new Quill('#editor', {
            theme: 'snow'
        });

        // Autosave function
        function autosave() {
            const content = JSON.stringify(quill.getContents());
            fetch(`/editor/document/${docId}/autosave/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken,
                },
                body: new URLSearchParams({ content }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Document autosaved.');
                }
            })
            .catch(err => console.error('Autosave failed:', err));
        }

        // Manual save function
        function saveDocument() {
            autosave();
            alert('Document saved!');
        }

        // Download document in Word format
        function downloadDocument() {
            window.location.href = `/editor/document/${docId}/download/`;
        }

        // Create a new document
        function createNewDocument() {
            window.location.href = `/editor/document/new/`;
        }

        // Autosave at regular intervals
        setInterval(autosave, autosaveInterval);

        // Set up WebSocket connection for collaborative editing
        const ws = new WebSocket('ws://' + window.location.host + '/ws/editor/' + docId + '/');

        ws.onopen = () => {
            console.log('Connected to WebSocket!');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'content_update') {
                quill.setContents(data.content);
            } else if (data.type === 'cursor_position') {
                const userId = data.user_id; // Unique ID for each user
                const cursorPosition = data.cursor_position;

                // Add a cursor element for the user if it doesn't already exist
                let userCursor = document.getElementById(`cursor-${userId}`);
                if (!userCursor) {
                    userCursor = document.createElement('div');
                    userCursor.id = `cursor-${userId}`;
                    userCursor.className = 'user-cursor';
                    userCursor.style.backgroundColor = data.color || 'red'; // Optional user-specific color
                    document.body.appendChild(userCursor);
                }

                // Update cursor position
                const bounds = quill.getBounds(cursorPosition.index);
                userCursor.style.left = bounds.left + 'px';
                userCursor.style.top = bounds.top + 'px';
            }
        };

        ws.onclose = () => {
            console.log('WebSocket connection closed.');
        };

        quill.on('text-change', () => {
            const content = quill.getContents();
            ws.send(JSON.stringify({ type: 'content_update', content }));
        });

        // Send cursor position on selection change
        quill.on('selection-change', (range) => {
            if (range) {
                ws.send(JSON.stringify({
                    type: 'cursor_position',
                    cursor_position: range,
                    user_id: 'unique_user_id', // Replace with the actual user's unique ID
                }));
            }
        });
    </script>
</body>
</html>
