<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        .user-cursor {
            position: absolute;
            background-color: red;
            width: 2px;
            height: 20px;
            z-index: 10;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h1>{{ title }} </h1>
    <h2>{{ request.user.username }}</h2>
    <button onclick="saveDocument()">Save</button>
    <button onclick="downloadDocument()">Download</button>
    <button onclick="createNewDocument()">New Document</button>
    <button onclick="openDocumentList()">Open Document</button>
    <button id="add-comment">Add Comment</button>
    <a href="{% url 'logout' %}" class="btn btn-dark">Logout</a>

    
    <style>
        #editor-container {
            height: 300px;
            border: 1px solid #ccc;
        }
        #comments-sidebar {
            margin-top: 10px;
        }
    </style>


    <div id="editor-container">
        <div id="editor"></div>
    </div>
    <div id="document-content" contenteditable="true">
        {{ document.content|safe }}
    </div>


    <div id="document-list" style="display: none;">
        <h2>Select a document to open:</h2>
        <ul id="document-list-items"></ul>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        const docId = "{{ doc_id }}";  // Initialize with a placeholder ID
        const csrfToken = "{{ csrf_token }}";
        const autosaveInterval = 5000;  // Autosave every 5 seconds

        const quill = new Quill('#editor', {
            theme: 'snow'
        });

        // Function to get the list of documents
        function openDocumentList() {
            fetch('/editor/document/list/')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const listItems = data.documents.map(doc => {
                            return `<li onclick="openDocument('${doc}')">${doc}</li>`;
                        }).join('');
                        document.getElementById('document-list-items').innerHTML = listItems;
                        document.getElementById('document-list').style.display = 'block';
                    }
                });
        }

        // Open a document by title
        async function loadDocument(documentId) {
    const response = await fetch(`/editor/open/${documentId}/`);
    const result = await response.json();
    if (result.document) {
        quill.root.innerHTML = result.document.content; // Load content
        displayComments(result.document.comments); // Handle comment display
    } else {
        alert(result.error);
    }
}


        // Autosave function
        function autosave() {
            const content = JSON.stringify(quill.getContents());
            fetch(`/editor/document/${docId}/autosave/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken,
                },
                body: new URLSearchParams({ content }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Document autosaved.');
                }
            })
            .catch(err => console.error('Autosave failed:', err));
        }

        document.getElementById('document-content').addEventListener('click', function (e) {
        const position = window.getSelection().anchorOffset; // Get cursor position
        const commentContent = prompt('Enter your comment:');
        if (commentContent) {
            addComment(position, commentContent);
        }
    });

    

    // Handle text selection to add comments
    quill.on('text-change', (delta, oldDelta, source) => {
    console.log('Text change detected:', delta);
});

document.querySelector('#add-comment').addEventListener('click', () => {
    const commentText = prompt('Enter your comment:');
    if (commentText) {
        const range = quill.getSelection();
        if (range) {
            quill.insertText(range.index, `[${commentText}]`, { bold: true });
        } else {
            alert('Please select a text to add a comment.');
        }
    }
});


        // Save document
        document.querySelector('#save-button').addEventListener('click', async () => {
    const content = quill.root.innerHTML; // Get editor content
    const comments = []; // Collect your comments array here
    const response = await fetch(`/editor/save/${documentId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content, comments })
    });
    const result = await response.json();
    alert(result.message || result.error);
});

</script>
</body>
</html>
